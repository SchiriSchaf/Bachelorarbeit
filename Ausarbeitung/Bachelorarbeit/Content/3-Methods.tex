%% ==============================
\chapter{\iflanguage{ngerman}{Methoden}{Methods}}
\label{sec:methods}
%% ==============================

Nachdem beschlossen wurde, dass diese Arbeit sich an dem Clusteringverfahren aus dem Paper von Nguyen \cite{nguyen2012clustering} orientiert, werden in diesem Kapitel die verschiedenen verwendeten Methoden vorgestellt.

\subsection{Gradient}

Zuerst müssen die Gradienten aller Voxel berechnet werden. Dafür wurde Hong's Methode \cite{hong2003method} gewählt. Diese ist ein approximationsbasiertes Verfahren zur Berechnung von Gradienten eines Volumens. 
\newline
In Hong's Verfahren wird zur Berechnung der Gradienten die lokale 4x4x4 Nachbarschaft des betrachteten Punktes hinzugezogen.
\newline
Hierbei ist zu beachten, dass es nicht möglich ist, den Gradienten für einen Voxel direkt zu berechnen. Der Gradient drückt die Veränderung der Intensitätswerte im Raum aus, folglich kann er immer nur zwischen mehreren Punkten berechnet werden. Deshalb liegt er im Falle eines dreidimensionalen Volumens im Zentrum eins Würfels, der von 8 benachbarten Voxeln aufgespannt wird.
\newline
In \autoref{fig:nachbarschaft} ist zu erkennen, wie der Gradient im Zentrum der acht Voxel liegt. Des Weiteren ist die 4x4x4 Nachbarschaft in Form der durchnummerierten Punkte zu sehen.
\newline

\begin{figure}[!h] 
\centering 
\includegraphics[width=0.75\textwidth]{Logos/VoxelEdges.PNG}
\caption{Darstellung der lokalen 4x4x4 Nachbarschaft  \\ Entnommen aus Hong's Paper} 
\label{fig:nachbarschaft} 
\end{figure}


Die Funktionen der Intensitätswerte wird im Paper mit:
\begin{equation}
	f(x,y,z) = Ax^{2}+By^{2}+Cz^{2}+2Fyz+2Gzx+2Hxy+2Ix+2Jy+2Kz+D
\end{equation}
approximiert.
\newline
Da der Gradient die Ableitung der Intensitätsfunktion ist, muss diese abgeleitet werden, um dreidimensionalen Gradientenvektor $n$ zu erhalten:
\begin{equation}
	n = [Ax+Gz+Hy+I, By+Fz+Hx+J, Cz + Fy + Gx + K]
\end{equation}
Um den Gradienten zu berechnen müssen folglich die Parameter $A,B,C,E,F,G,H,I,J,K$ kalkuliert werden. Dies wird mithilfe der Methode der kleinsten Quadrate und der im Paper vorgestellten \textit{error distance}, die die Entfernung zwischen einem berechneten Datenpunkt und seinem korrespondierenden Punkt in den tatsächlichen Daten beschreibt, umgesetzt.
\newline
Wurden die Parameter berechnet kann der Gradient $[X, Y, Z]$ des Punktes $[x, y, z]$ mit folgender Formel kalkuliert werden:

\begin{align}
\begin{bmatrix}
           X \\
           Y \\
           Z
         \end{bmatrix}    
 	= \begin{bmatrix}
           2A & 2H & 2G \\
           2H & 2B & 2F \\
           2G & 2F & 2C
         \end{bmatrix}
         \begin{bmatrix}
           x \\
           y \\
           z
         \end{bmatrix}
	+\begin{bmatrix}
           2I \\
           2J \\
           2K
         \end{bmatrix}
  \end{align}




\subsection{LH-Werte}

Als nächster Schritt folgt die Berechnung der Low- und High-Werte. Dazu wird für jeden Voxel im Volumen in Richtung des Gradienten integriert.
\newline
Hierfür wurde Heun's Methode, eine modifizierte Euler Methode, verwendet. Die für die Integration benutzte Formel lautet:
\begin{equation}
	u_{i+1} = u_{i} + \frac{1}{2}d(\triangledown f (u_{i}) + \triangledown f(u_{i}+d \triangledown f(u_{i}))) 
\end{equation}
Hierbei sind $u_{i}$ und $u_{i+1}$ die Positionen des aktuellen, beziehungsweise des nächsten Voxels. $\triangledown f(x)$ beschreibt den normalisierten Gradienten bei der Berechnung der High-Werte und den normalisierten inversen Gradiente bei der Berechnung der Low-Werte des Punktes $x$ . $d$ steht für die Schrittweite, die in dieser Arbeit auf einen Voxel festgelegt wurde.
\newline
Die Integration stoppt, wenn eine lokale Extremstelle oder ein Wendepunkt erreicht wird. Diese sind daran zu erkennen, dass die Längen der Gradienten an diesen Stellen null sind.
\newline
Wird ein solcher Punkt erreicht, wird der Intensitätswert des aktuell besuchten Voxels als Ergebnis für den Low- beziehungsweise High-Wert des Startvoxel gespeichert.
\newline
Anschließend wird ein LH-Histogramm mit allen berechneten LH-Wertpaaren erstellt. Hierbei sind auf der x-Achse die Low-Werte und auf der y-Achse die High-Werte angesiedelt. Die Werte der Achsen reichen von null bis zum jeweiligen Maximum der Low- beziehungsweise High-Werte.



\subsection{LH-Clustering}

Als nächstes, wird der erste Clusteringschritt durchgeführt. Dieser findet über dem LH-Raum, genauer gesagt auf dem eben berechneten LH-Histogramm statt. Dafür wird \textit{Meanshiftclustering} verwendet.
\newline
Vor dem Berechnen der Cluster muss zunächst eine Bandweite sowie ein Thresholdwert bestimmt werden, welche die Sensitivität des Clusterings festlegen.
\newline
Die von Nguyen \cite{nguyen2012clustering} verwendete Bandweite liegt bei 7\% bis 9\% des maximalen LH-Wertes und der Threshold bei 0,01. Anschließend kann die Kalkulation der Cluster beginnen.
\newline
Für einen beliebigen Punkt, werden alle Punkte die innerhalb des Radius der Bandbreite liegen gespeichert. Diese Punkte bilden den gefundenen Cluster. Von diesem Cluster wird der Mittelpunkt berechnet, indem jeweils die L- und die H-Werte aller Punkte des Clusters aufaddiert und durch die Anzahl der Punkte geteilt wird.
\newline
Um den neuen Mittelpunkt werden wieder alle Punkte, die innerhalb des Radius liegen und noch nicht zum Cluster gehören, hinzugefügt und anschließend erneut ein neuer Mittelpunkt berechnet.
\newline
Dies geschieht solange, bis die Distanz des neu kalkulierte Mittelpunkt zum alten kleiner als der Thresholdwert multipliziert mit die Bandweite ist. 
\newline
Nachdem diese Prozedur für jeden Punkt im Histogramm ausgeführt wurde, existieren viele Cluster, die oftmals aus vielen gleichen Punkten bestehen.
\newline
Um dies zu unterbinden werden in einem nächsten Schritt alle Cluster die sehr nah beieinander liegen verschmolzen. Dies betrifft jene Cluster, deren Mittelpunkte eine Distanz kleiner als die Hälfte der Bandweite zueinander haben.



\subsection{Räumliches-Clustering}

Als letzten Schritt, wird erneut auf jedem eben entstandenen Cluster \textit{Meanshiftclustering} angewendet. Dabei wird auf jedem Cluster einzeln und unabhängig von den anderen Clustern geclustert. Außerdem werden diesmal die räumlichen Informationen der Punkte in Betracht gezogen.
\newline
Hierzu müssen zunächst erneut die beiden Parameter Bandweite und Threshold definiert werden.
\newline
Anschließend läuft das Clusteringt wie zuvor im LH-Raum ab, mit dem Unterschied, dass statt im zweidimensionalem Raum mit einem zweidimensionalem Kreis im dreidimensionalem Raum des Volumens mit einer dreidimensionalen Kugel nach Voxeln gesucht wird.
\newline
Des Weiteren findet am Ende der Berechnung der Cluster keine Verschmelzung statt, da dies den Sinn der beiden verschiedenen Clusteringschritte zerstören würde. In den finalen Cluster haben alle Punkte jeweils ähnliche LH-Werte und liegen im Volumen nah beieinander.
\newline
Würden diese Cluster anhand ihrer räumlichen Informationen verschmolzen werden, hätten die Punkte keine ähnlichen LH-Werte mehr und der erste Clusteringschritt wäre umsonst gewesen.



\subsection{Hierarchisches-Clustering}

Der vorgestellte dritte hierarchische Clusteringsschritt wurde in dieser Arbeit nicht angewendet. Dies wurde aus dem Grund entschieden, dass bei diesem immer die beiden Cluster die sich am nächsten sind verschmolzen werden.
 \newline
Dies ist für die Aufgabe das Ventrikelsystem hervorzuheben nicht zielführend. Wird das System als ein oder mehrere Cluster erkannt, liegen diese mitten im Gehirn neben sehr vielen anderen Clustern.
\newline
Da das Ventrikelsystem sehr länglich ist, ist es bei der Verschmelzung unwahrscheinlich, dass die zum dazugehörigen Cluster nur miteinander verschmolzen werden. Sie würden vermutlich meistens mit anderen umliegenden Strukturen verschmolzen werden.

